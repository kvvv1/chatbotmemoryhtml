<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Chat Multi Sistema — Memory</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root{
      --memory-red:#E50914;
      --memory-red-700:#b0060f;
      --gray-100:#F5F6F7;
      --gray-200:#E9EBEF;
      --gray-300:#D8DCE2;
      --gray-600:#4B4F56;
      --gray-800:#2F3238;
      --white:#ffffff;
    }

    *{margin:0;padding:0;box-sizing:border-box}
    html,body{height:100%}
    body{
      font-family:"Inter",-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;
      background:radial-gradient(1200px 700px at 20% -10%,#ffffff 0%,#f2f3f5 40%,#e9ebef 100%);
      color:var(--gray-600);
      overflow:hidden;
    }

    .app{
      display:grid;
      grid-template-columns: 1fr 360px;
      grid-template-rows: 64px 1fr;
      grid-template-areas:
        "topbar right"
        "chat   right";
      height:100vh;
    }

    .topbar{
      grid-area:topbar;
      display:flex;align-items:center;gap:12px;
      padding:0 18px;
      background:var(--gray-800);
      color:var(--white);
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    #logoMemory{height:28px;width:auto;display:block}
    .title{font-weight:700;letter-spacing:.2px;font-size:16px;line-height:1}
    .subtitle{font-size:12px;opacity:.8}

    .right{
      grid-area:right;display:flex;flex-direction:column;
      border-left:1px solid var(--gray-200);background:var(--white)
    }
    .right header{padding:16px 18px;border-bottom:1px solid var(--gray-200);font-weight:700;color:#1d1f24}
    .guide{
      padding:16px 18px;overflow:auto;height:100%;
      scrollbar-width:thin;scrollbar-color:var(--memory-red) transparent;
    }
    .guide::-webkit-scrollbar{width:10px}
    .guide::-webkit-scrollbar-thumb{background:var(--memory-red);border-radius:10px;border:2px solid transparent}
    .guide section{margin-bottom:18px}
    .guide h4{font-size:13px;color:#1d1f24;margin-bottom:8px}
    .guide p,.guide li{font-size:13px;line-height:1.55}
    .guide ul{padding-left:18px}

    .chat{
      grid-area:chat;display:flex;flex-direction:column;background:var(--gray-100);height:100%;
      overflow:hidden;
    }

    #chat{
      flex:1;overflow:auto;padding:20px;
      scrollbar-width:thin;scrollbar-color:var(--memory-red) transparent;
      background:var(--gray-100);
    }
    #chat::-webkit-scrollbar{width:10px}
    #chat::-webkit-scrollbar-thumb{background:var(--memory-red);border-radius:10px;border:2px solid var(--gray-100)}

    .message{
      max-width:75%;padding:12px 16px;border-radius:16px;
      line-height:1.6;font-size:14px;margin:10px 0;
      box-shadow:0 1px 4px rgba(0,0,0,.06);
      animation:slide .22s ease;
    }
    @keyframes slide{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
    .user{margin-left:auto;background:var(--memory-red);color:#fff;border-bottom-right-radius:6px}
    .bot{margin-right:auto;background:#fff;color:#1d1f24;border:1px solid var(--gray-200);border-bottom-left-radius:6px}
    .bot strong{color:#111}

    .status{
      text-align:center;font-size:12.5px;color:#333;margin:10px auto;
      padding:8px 12px;background:#fff;border-radius:999px;border:1px solid var(--gray-200)
    }
    .typing{display:inline-flex;gap:4px;align-items:center;margin-right:6px}
    .typing span{width:7px;height:7px;background:var(--memory-red);border-radius:50%;animation:typing 1.4s infinite}
    .typing span:nth-child(2){animation-delay:.2s}
    .typing span:nth-child(3){animation-delay:.4s}
    @keyframes typing{0%,60%,100%{transform:translateY(0)}30%{transform:translateY(-8px)}}

    .suggestions{
      padding:12px 18px;border-top:1px solid var(--gray-200);border-bottom:1px solid var(--gray-200);
      display:flex;flex-wrap:wrap;gap:10px;background:#fff;
    }
    .chip{
      border:1px solid var(--gray-300);background:#fff;color:#1d1f24;
      padding:8px 12px;border-radius:999px;font-size:12.5px;cursor:pointer;transition:all .15s ease;
    }
    .chip:hover{border-color:var(--memory-red);color:var(--memory-red)}

    .controls{
      padding:14px 18px;background:#fff;border-top:1px solid var(--gray-200);
      display:flex;gap:10px;
    }
    input,button{
      padding:12px 14px;border-radius:12px;border:1px solid var(--gray-200);
      font-size:14px;font-family:inherit;background:#fff
    }
    /* REMOVE glow vermelho no foco */
    input[type="text"]{flex:1;outline:none;transition:border-color .2s}
    input[type="text"]:focus{border-color:var(--memory-red);box-shadow:none}

    /* REMOVE sombras vermelhas do botão; hover neutro suave */
    button{
      background:var(--memory-red);color:#fff;border:none;cursor:pointer;min-width:120px;font-weight:700;
      box-shadow:none;transition:transform .16s ease, box-shadow .16s ease, opacity .16s ease;
    }
    button:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,.12)}
    button:active{transform:translateY(0)}
    button:disabled{opacity:.6;cursor:not-allowed}

    @media (max-width: 980px){
      .app{grid-template-columns:1fr;grid-template-areas:"topbar" "chat";height:100dvh}
      .right{display:none}
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="topbar">
      <img id="logoMemory" src="assets/logo.png" alt="Memory" />
      <div>
        <div class="title">Chat Multi Sistema</div>
        <div class="subtitle">Chatbot inteligente para insights, respostas e relatórios</div>
      </div>
    </div>

    <aside class="right">
      <header>Como funciona</header>
      <div class="guide" id="guia">
        <section>
          <h4>1. Escreva em linguagem natural</h4>
          <p>Peça consultas, relatórios e análises. O sistema identifica automaticamente o módulo (frotas, folha, contabilidade, compras, patrimônio, tributos).</p>
        </section>
        <section>
          <h4>2. Dê contexto quando precisar</h4>
          <ul>
            <li>Inclua datas, códigos, placas ou CNPJ/CPF se for relevante.</li>
            <li>Especifique períodos, filtros e formatos de saída (tabela, resumo, PDF).</li>
          </ul>
        </section>
        <section>
          <h4>3. Exemplos prontos</h4>
          <ul id="exemplosGuia"></ul>
        </section>
        <section>
          <h4>4. Privacidade</h4>
          <p>Somente dados autorizados para sua sessão são exibidos.</p>
        </section>
      </div>
    </aside>

    <main class="chat">
      <div id="chat"></div>
      <div class="suggestions" id="sugestoes"></div>
      <div class="controls">
        <input type="text" id="mensagem" placeholder="Ex.: Empenhos do mês, valor da folha, veículos com manutenção pendente..." />
        <button id="btnEnviar" onclick="enviarMensagem()">Enviar</button>
      </div>
    </main>
  </div>

  <script>
    let sessionId = null;
    const N8N_WEBHOOK = "https://n8n.webcidadao.com.br/webhook/940fd847-38aa-4748-91b8-cff9043b353b";

    const PROMPTS = [
      "Quantos veículos estão ativos e a última manutenção de cada um?",
      "Resumo da folha de pagamento do mês atual por secretaria.",
      "Listar empenhos do mês por elemento de despesa.",
      "Contratos que vencem nos próximos 30 dias.",
      "Itens de patrimônio sem depreciação registrada.",
      "Receita de IPTU por bairro no último trimestre.",
      "Despesas por natureza no bimestre corrente.",
      "Processos de compra acima de R$ 50.000 abertos.",
      "Funcionários com adicional de insalubridade.",
      "Veículos com IPVA/seguro a vencer em 30 dias."
    ];

    function sorteio(array, n){
      const pool=[...array];
      const out=[];
      while(out.length<n && pool.length){
        const i=Math.floor(Math.random()*pool.length);
        out.push(pool.splice(i,1)[0]);
      }
      return out;
    }

    // Utilitários de cookies e JWT
    function getCookie(name){
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if(parts.length===2) return decodeURIComponent(parts.pop().split(';').shift());
      return null;
    }

    function parseJwt(token){
      try{
        const payload=token.split('.')[1];
        const decoded=atob(payload.replace(/-/g,'+').replace(/_/g,'/'));
        return JSON.parse(decoded);
      }catch(e){
        return {};
      }
    }

    function renderSugestoes(){
      const container=document.getElementById("sugestoes");
      const exemplosGuia=document.getElementById("exemplosGuia");
      if(container) container.innerHTML="";
      if(exemplosGuia) exemplosGuia.innerHTML="";

      const picks=sorteio(PROMPTS,4);
      picks.forEach(txt=>{
        const chip=document.createElement("button");
        chip.className="chip";
        chip.textContent=txt;
        chip.onclick=()=>{document.getElementById("mensagem").value=txt;document.getElementById("mensagem").focus();};
        container.appendChild(chip);

        if(exemplosGuia){
          const li=document.createElement("li");
          li.textContent=txt;
          exemplosGuia.appendChild(li);
        }
      });
    }

    function adicionarMensagem(texto,tipo){
      const chat=document.getElementById("chat");
      const div=document.createElement("div");
      div.className="message "+tipo;
      texto = texto.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>').replace(/\n/g,'<br>');
      div.innerHTML = texto;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }

    function mostrarStatus(){
      const chat=document.getElementById("chat");
      const id="status-"+Date.now();
      const div=document.createElement("div");
      div.id=id; div.className="status";
      div.innerHTML='<span class="typing"><span></span><span></span><span></span></span> Processando...';
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
      return id;
    }

    function removerStatus(id){
      const el=document.getElementById(id);
      if(el) el.remove();
    }

    function desabilitarInput(disabled){
      document.getElementById("mensagem").disabled=disabled;
      document.getElementById("btnEnviar").disabled=disabled;
    }

    async function enviarMensagem(){
      const input=document.getElementById("mensagem");
      const msg=input.value.trim();
      if(!msg) return;

      adicionarMensagem(msg,'user');
      input.value="";
      desabilitarInput(true);
      const statusId=mostrarStatus();
      
      // Captura de variáveis dos cookies e JWT
      const access_token = getCookie("access_token"); // cookie access_token
      const jwtData = parseJwt(access_token || "");   // decodifica JWT
      const entidadeCookie = getCookie("entidade");   // cookie entidade
      const municipioCookie = getCookie("municipio"); // cookie municipio
      const tenantCookie = getCookie("tenant_id");    // cookie tenant_id

      // Montagem do payload enviado ao N8N (schema = codigoIbge)
      const payload={
        entidade: entidadeCookie || jwtData.tenantId || "GLOBAL",
        municipio: municipioCookie || null,
        tenant_id: tenantCookie || jwtData.tenantId || null,
        access_token: access_token || null,
        codigoIbge: jwtData.codigoIbge || null,
        schema: jwtData.codigoIbge || null,
        mensagem: msg,
        sessionId: sessionId || ('memory-' + Date.now())
      };

      console.log("Payload enviado ao N8N:", payload);

      try{
        const res=await fetch(N8N_WEBHOOK,{
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body:JSON.stringify(payload)
        });
        if(!res.ok) throw new Error("Erro HTTP: "+res.status);
        const data=await res.json();
        removerStatus(statusId);
        if(data.error){
          adicionarMensagem(data.text || "Erro desconhecido",'bot');
        }else{
          adicionarMensagem(data.text || JSON.stringify(data),'bot');
        }
      }catch(error){
        removerStatus(statusId);
        adicionarMensagem("Erro ao conectar com o servidor: " + error.message,'bot');
      }
      desabilitarInput(false);
      input.focus();
    }

    document.addEventListener('DOMContentLoaded',()=>{
      sessionId = 'memory-' + Date.now();
      renderSugestoes();
      document.getElementById("mensagem").addEventListener("keydown",e=>{
        if(e.key==="Enter" && !e.shiftKey){e.preventDefault();enviarMensagem();}
      });
    });
  </script>
</body>
</html>
