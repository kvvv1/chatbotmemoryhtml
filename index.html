<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>üí¨ Chatbot Multi Sistema</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      width: 100%;
      max-width: 800px;
      height: 85vh;
      background: #fff;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    
    header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      padding: 20px;
      text-align: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    header h1 {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 5px;
    }
    
    header p {
      font-size: 14px;
      opacity: 0.9;
    }
    
    #chat {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      background: #f5f7fa;
      font-size: 15px;
    }
    
    #chat::-webkit-scrollbar {
      width: 8px;
    }
    
    #chat::-webkit-scrollbar-track {
      background: #f1f1f1;
    }
    
    #chat::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 4px;
    }
    
    .message {
      margin: 12px 0;
      max-width: 75%;
      padding: 12px 16px;
      border-radius: 18px;
      line-height: 1.5;
      word-wrap: break-word;
      font-size: 14px;
      animation: slideIn 0.3s ease;
    }
    
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .user {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      margin-left: auto;
      border-bottom-right-radius: 4px;
    }
    
    .bot {
      background: #fff;
      color: #333;
      margin-right: auto;
      border-bottom-left-radius: 4px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .bot strong {
      color: #667eea;
    }
    
    .status {
      text-align: center;
      font-size: 13px;
      color: #888;
      margin: 10px auto;
      padding: 8px;
      background: rgba(255,255,255,0.8);
      border-radius: 12px;
      display: block;
      max-width: fit-content;
    }
    
    .typing {
      display: inline-flex;
      gap: 4px;
      align-items: center;
    }
    
    .typing span {
      width: 8px;
      height: 8px;
      background: #667eea;
      border-radius: 50%;
      animation: typing 1.4s infinite;
    }
    
    .typing span:nth-child(2) {
      animation-delay: 0.2s;
    }
    
    .typing span:nth-child(3) {
      animation-delay: 0.4s;
    }
    
    @keyframes typing {
      0%, 60%, 100% {
        transform: translateY(0);
      }
      30% {
        transform: translateY(-10px);
      }
    }
    
    .controls {
      padding: 20px;
      background: #fff;
      display: flex;
      gap: 10px;
      border-top: 1px solid #e0e0e0;
    }
    
    input, select, button {
      padding: 12px 16px;
      border-radius: 12px;
      border: 1px solid #ddd;
      font-size: 14px;
      font-family: inherit;
    }
    
    input[type="text"] {
      flex: 1;
      outline: none;
      transition: all 0.3s;
    }
    
    input[type="text"]:focus {
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    select {
      background: #fff;
      cursor: pointer;
      outline: none;
    }
    
    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      border: none;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 600;
      min-width: 100px;
    }
    
    button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }
    
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    #configBox {
      padding: 30px;
      background: #fff;
      display: block;
    }
    
    #configBox.hidden {
      display: none;
    }
    
    #configBox label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
      font-size: 14px;
    }
    
    #configBox input,
    #configBox select {
      width: 100%;
      margin-bottom: 20px;
    }
    
    #configBox .info {
      background: #f0f4ff;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 20px;
      border-left: 4px solid #667eea;
    }
    
    #configBox .info p {
      font-size: 13px;
      color: #555;
      line-height: 1.6;
    }
    
    #chatBox {
      display: none;
      flex-direction: column;
      flex: 1;
    }
    
    #chatBox.active {
      display: flex;
    }
    
    .system-badge {
      display: inline-block;
      padding: 4px 10px;
      background: #667eea;
      color: white;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      margin-left: 8px;
    }
    
    .error {
      background: #fee;
      color: #c33;
      border-left: 4px solid #c33;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üí¨ Chatbot Multi Sistema</h1>
      <p>Assistente inteligente para gest√£o p√∫blica</p>
    </header>

    <div id="configBox">
      <div class="info">
        <p><strong>üëã Bem-vindo!</strong></p>
        <p>Configure sua sess√£o selecionando a entidade e o sistema que deseja consultar.</p>
      </div>
      
      <label>üèõÔ∏è Entidade</label>
      <input type="text" id="entidade" value="Prefeitura A" placeholder="Digite o nome da entidade">
      
      <label>üñ•Ô∏è Sistema</label>
      <select id="sistema">
        <option value="SCF">üöó Controle de Frotas (SCF)</option>
        <option value="SPA">üè¢ Patrim√¥nio (SPA)</option>
        <option value="STM">üí∞ Tributa√ß√£o Municipal (STM)</option>
        <option value="SIP">üë• Folha de Pagamento (SIP)</option>
        <option value="SCP">üìä Contabilidade P√∫blica (SCP)</option>
        <option value="SIC">üìã Compras e Licita√ß√µes (SIC)</option>
      </select>
      
      <button onclick="iniciarSessao()">üöÄ Iniciar Sess√£o</button>
    </div>

    <div id="chatBox">
      <div id="chat"></div>
      <div class="controls">
        <input type="text" id="mensagem" placeholder="Digite sua pergunta...">
        <button id="btnEnviar" onclick="enviarMensagem()">Enviar</button>
      </div>
    </div>
  </div>

  <script>
    let entidadeData = null;
    let sessionId = null;
    const N8N_WEBHOOK = "https://n8n.webcidadao.com.br/webhook/940fd847-38aa-4748-91b8-cff9043b353b";

    const SYSTEM_NAMES = {
      'SCF': 'Controle de Frotas',
      'SPA': 'Patrim√¥nio',
      'STM': 'Tributa√ß√£o Municipal',
      'SIP': 'Folha de Pagamento',
      'SCP': 'Contabilidade P√∫blica',
      'SIC': 'Compras e Licita√ß√µes'
    };

    function iniciarSessao() {
      console.log('Iniciando sess√£o...');
      
      const entidadeInput = document.getElementById("entidade").value.trim();
      const sistemaInput = document.getElementById("sistema").value;
      
      console.log('Entidade:', entidadeInput);
      console.log('Sistema:', sistemaInput);
      
      if (!entidadeInput) {
        alert("‚ö†Ô∏è Por favor, preencha o nome da entidade");
        return;
      }
      
      entidadeData = {
        entidade: entidadeInput,
        sistema: sistemaInput
      };
      
      sessionId = entidadeData.entidade + "-" + entidadeData.sistema + "-" + Date.now();
      
      console.log('SessionId:', sessionId);
      
      // Esconde config e mostra chat
      const configBox = document.getElementById("configBox");
      const chatBox = document.getElementById("chatBox");
      
      configBox.classList.add("hidden");
      chatBox.classList.add("active");
      
      console.log('Boxes trocados');
      
      const sistemaName = SYSTEM_NAMES[sistemaInput];
      document.getElementById("chat").innerHTML = 
        '<div class="status">' +
        '‚úÖ Sess√£o iniciada<br>' +
        '<strong>' + entidadeData.entidade + '</strong>' +
        '<span class="system-badge">' + sistemaName + '</span>' +
        '</div>';
      
      document.getElementById("mensagem").focus();
      
      console.log('Sess√£o iniciada com sucesso');
    }

    async function enviarMensagem() {
      const input = document.getElementById("mensagem");
      const msg = input.value.trim();
      
      if (!msg) return;

      adicionarMensagem(msg, 'user');
      input.value = "";
      desabilitarInput(true);

      const statusId = mostrarStatus();

      const payload = {
        entidade: entidadeData.entidade,
        sistema: entidadeData.sistema,
        mensagem: msg,
        sessionId: sessionId
      };

      try {
        const res = await fetch(N8N_WEBHOOK, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        if (!res.ok) {
          throw new Error("Erro HTTP: " + res.status);
        }

        const data = await res.json();
        
        removerStatus(statusId);
        
        if (data.error) {
          adicionarMensagem(data.text || "Erro desconhecido", 'bot error');
        } else {
          adicionarMensagem(data.text || JSON.stringify(data), 'bot');
        }
        
      } catch (error) {
        removerStatus(statusId);
        adicionarMensagem("‚ùå Erro ao conectar com o servidor: " + error.message, 'bot error');
      }

      desabilitarInput(false);
      input.focus();
    }

    function adicionarMensagem(texto, tipo) {
      const chat = document.getElementById("chat");
      const div = document.createElement("div");
      div.className = "message " + tipo;
      
      // Processa markdown b√°sico
      texto = texto
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\n/g, '<br>');
      
      div.innerHTML = texto;
      chat.appendChild(div);
      scrollChat();
    }

    function mostrarStatus() {
      const chat = document.getElementById("chat");
      const statusId = "status-" + Date.now();
      const div = document.createElement("div");
      div.id = statusId;
      div.className = "status";
      div.innerHTML = 
        '<div class="typing">' +
        '<span></span>' +
        '<span></span>' +
        '<span></span>' +
        '</div>' +
        ' Processando...';
      chat.appendChild(div);
      scrollChat();
      return statusId;
    }

    function removerStatus(statusId) {
      const status = document.getElementById(statusId);
      if (status) {
        status.remove();
      }
    }

    function desabilitarInput(disabled) {
      document.getElementById("mensagem").disabled = disabled;
      document.getElementById("btnEnviar").disabled = disabled;
    }

    function scrollChat() {
      const chat = document.getElementById("chat");
      chat.scrollTop = chat.scrollHeight;
    }

    // Event listeners
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM carregado');
      
      document.getElementById("mensagem").addEventListener("keydown", function(e) {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          enviarMensagem();
        }
      });

      document.getElementById("entidade").addEventListener("keydown", function(e) {
        if (e.key === "Enter") {
          e.preventDefault();
          iniciarSessao();
        }
      });
    });
  </script>
</body>
</html>